<!--
Copyright (C) 2026 Advanced Micro Devices, Inc. All rights reserved.
Licensed under the MIT License.
-->
# llvm-mlir-prebuilt

Prebuilt LLVM/MLIR/LLD binaries for Windows x64, built from source on a local
machine and distributed via GitHub Releases.

## Contents

Each release contains a single zip (split into parts if over 2GB):
- `llvm-mlir-lld-<version>-windows-x64.zip` — all static libraries, headers,
  cmake config files (`LLVMConfig.cmake`, `MLIRConfig.cmake`, `LLDConfig.cmake`),
  and tools (`FileCheck`, `llvm-tblgen`, `mlir-tblgen`, `clang`, etc.)

The zip is built directly from CMake's `install_manifest.txt`, so it contains
exactly what was installed — no more, no less.

## Build Configuration

### LLVM/MLIR/LLD

- **Version**: see release tag
- **Projects**: `mlir;lld;clang`
- **Targets**: `host` (x86_64)
- **Build type**: Release
- **Compiler**: MSVC (`cl.exe`)
- **Runtime**: `/MT` (`MultiThreaded`)
- **RTTI**: OFF
- **Shared libs**: OFF (static only)
- **Assertions**: ON
- **Zlib**: OFF

### protobuf

- **Version**: see release tag
- **Build type**: Release
- **Compiler**: MSVC (`cl.exe`)
- **Runtime**: `/MT` (`MultiThreaded`)
- **Shared libs**: OFF (static only)
- **Tests**: OFF
- **abseil**: bundled (`protobuf_ABSL_PROVIDER=module`)
- **C++ standard**: 17

## How to Consume in CMake

Extract all zip files to the same directory (e.g., `../local`), then:

```bash
cmake -DCMAKE_PREFIX_PATH=/path/to/local ...
```

CMake will find `LLVMConfig.cmake`, `MLIRConfig.cmake`, and `LLDConfig.cmake`
automatically.

## How to Download in CI

```yaml
- name: Download prebuilt LLVM/MLIR/LLD
  shell: bash
  run: |
    mkdir -p local
    gh release download <tag> \
      --repo wcy123/llvm-mlir-prebuilt \
      --pattern "*.zip" \
      --dir ./llvm-pkg
    for f in ./llvm-pkg/*.zip; do
      unzip -q "$f" -d ./local
    done
  env:
    GH_TOKEN: ${{ github.token }}
```

## How to Build and Publish a New Release

### 1. Get the source

Shallow-clone into `.workspace/` at the repo root (gitignored):

```bash
# LLVM/MLIR/LLD
git clone --depth 1 --branch llvmorg-<version> \
  https://github.com/llvm/llvm-project.git \
  .workspace/llvm-project

# protobuf
git clone --depth 1 --branch v<version> \
  https://github.com/protocolbuffers/protobuf.git \
  .workspace/protobuf
```

### 2. Build

Run each build script from its cloned source directory:

```bash
# LLVM/MLIR/LLD
cd .workspace/llvm-project
bash ../../scripts/build-llvm.sh

# protobuf
cd .workspace/protobuf
bash ../../scripts/build-protobuf.sh
```

The script derives all paths relative to the source root — no hardcoded
machine-specific directories:

```
llvm-mlir-prebuilt/               ← repo root
  .workspace/                     ← gitignored
    llvm-project/                 ← source (run script from here)
    build/llvm-project-release/   ← build artifacts
    local/                        ← install destination
  scripts/
    build-llvm.sh
    package-and-upload.sh
```

### 3. Package and upload

Run from the repo root. All paths are derived automatically:

```bash
# LLVM/MLIR/LLD
bash scripts/package-and-upload.sh --version llvm-<version>-release

# protobuf
bash scripts/package-and-upload.sh --name protobuf --version protobuf-<version>-release
```

Staging is driven by `install_manifest.txt` generated by CMake during install,
producing a single zip that contains exactly what was installed.
If the zip exceeds 2GB it is split into numbered parts automatically.

Options: `--build-dir <path>`, `--install-dir <path>`, `--dry-run`.
